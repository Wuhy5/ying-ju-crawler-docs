# 核心概念

## 概述

媒体爬虫规范的核心思想是将数据采集过程抽象为**配置驱动的管道处理系统**。

## 关键概念

### 1. 规则文件 (Rule File)

每个数据源由一个独立的 `.toml` 文件描述，包含：

- **元数据**: 规则的基本信息
- **网络配置**: HTTP 请求的全局设置
- **入口定义**: 如何触发数据采集（搜索、发现、分类等）
- **解析规则**: 如何从响应中提取数据
- **媒体特定配置**: 不同媒体类型的专有字段

### 2. 处理管道 (Pipeline)

管道是规范的核心机制，它将数据提取过程分解为一系列**原子步骤**：

```
输入数据 → 步骤1 → 步骤2 → ... → 步骤N → 输出结果
```

每个步骤接收前一步的输出作为输入，这种设计使得：
- 逻辑清晰，易于理解和维护
- 步骤可复用
- 支持复杂的数据处理流程

### 3. 媒体类型系统

规范采用**基于类型的扩展机制**：

```toml
[meta]
media_type = "video"  # 或 "audio", "book", "manga" 等
```

不同媒体类型：
- 共享通用的基础配置（元数据、HTTP、脚本等）
- 拥有各自特定的字段定义和解析规则
- 可独立演进，互不干扰

### 4. 入口机制

入口定义了如何**触发**数据采集，支持多种模式：

| 入口类型 | 用途 | 适用场景 |
|---------|------|---------|
| `discover` | 分类浏览 | 按分类、标签探索内容 |
| `search` | 关键词搜索 | 用户主动搜索 |
| `recommendation` | 推荐流 | 个性化推荐、热门内容 |
| `ranking` | 排行榜 | 榜单、热度排序 |

一个规则文件可以定义**多个入口**，满足不同的使用场景。

### 5. 两级解析

数据提取分为两个层次：

#### 列表页解析 (`parse.list`)
从列表页提取多个条目的**概要信息**：
- 标题、链接、封面、简介等
- 每个条目通过 `item_selector` 定位

#### 详情页解析 (`parse.detail`)
从详情页提取**完整信息**：
- 详细描述、播放链接、章节列表等
- 直接对整个页面处理

### 6. 脚本扩展

当声明式配置无法满足需求时，可以使用**自定义脚本**：

```toml
[scripting]
engine = "javascript"

[scripting.files]
crypto = "decrypt.js"
```

在管道中调用：
```toml
{ type = "script", call = "crypto.decrypt" }
```

脚本提供了**逃生舱**，确保规范能应对任意复杂的情况。

## 设计原则

### 1. 声明式优先
尽可能使用声明式配置，只在必要时使用脚本。

### 2. 渐进式复杂度
- 简单场景：几行配置即可
- 复杂场景：通过管道和脚本组合实现

### 3. 关注点分离
- 元数据、网络、解析等关注点独立配置
- 不同媒体类型的特定逻辑隔离

### 4. 约定优于配置
提供合理的默认值，减少必需配置项。

### 5. 可验证性
提供完整的 Schema，支持规则文件的自动验证。

## 工作流程

```
1. 加载规则文件 (TOML)
   ↓
2. 验证规则 (Schema)
   ↓
3. 根据入口类型构建初始请求
   ↓
4. 执行列表页解析
   ↓
5. 对每个条目执行详情页解析
   ↓
6. 返回结构化数据
```

## 下一步

- 阅读 [通用规范](./common-spec.md) 了解所有媒体类型共享的配置
- 查看 [处理管道](./pipeline/README.md) 深入理解管道机制
