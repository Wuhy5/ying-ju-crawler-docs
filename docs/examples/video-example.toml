# 影视数据源规则示例
# 
# 本示例演示如何为视频平台创建完整的爬虫规则，包含：
# - 搜索和分类发现
# - 列表页解析（使用 CSS 选择器）
# - 详情页解析
# - 多种字段提取技巧
#
# 实际使用时需要根据目标网站的实际 HTML 结构调整选择器

[meta]
name = "豆瓣电影"
author = "示例作者"
version = "1.0.0"
description = "豆瓣电影数据采集规则（示例）"
domain = "movie.douban.com"
media_type = "video"
encoding = "UTF-8"
icon_url = "https://movie.douban.com/favicon.ico"
language = "zh-CN"
region = "CN"
tags = ["电影", "评分", "影评"]

# HTTP 全局配置
[http]
user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
timeout = 30
retry_times = 3
retry_delay = 1000
rate_limit = 5

[http.headers]
Referer = "https://movie.douban.com/"
Accept-Language = "zh-CN,zh;q=0.9,en;q=0.8"
Accept = "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"

# 搜索入口：通过关键词搜索
[search]
entry_url_template = "https://{domain}/search?q={keyword}&page={page}"
method = "GET"
response_type = "html"

# 分类发现入口：按分类浏览
[discover]
entry_url_template = "https://{domain}/tag/{cate_id}?page={page}"
method = "GET"
response_type = "html"

[[discover.categories]]
name = "电影"
id = "movie"

[[discover.categories]]
name = "电视剧"
id = "tv"

[[discover.categories]]
name = "综艺"
id = "variety"

[[discover.categories]]
name = "纪录片"
id = "documentary"

# 排行榜入口
[ranking]
entry_url_template = "https://{domain}/rank/{type}?period={period}"
response_type = "html"

[[ranking.types]]
name = "热度榜"
id = "hot"

[[ranking.types]]
name = "评分榜"
id = "rating"

[[ranking.periods]]
name = "日榜"
id = "daily"

[[ranking.periods]]
name = "周榜"
id = "weekly"

[[ranking.periods]]
name = "月榜"
id = "monthly"

# 解析规则
[parse]
  # 列表页解析：从搜索或分类结果提取条目列表
  [parse.list]
    # 使用 CSS 选择器定位每个条目
    # 假设每个条目由 <div class="item"> 包装
    item_selector = { type = "selector", query = "div.item" }
    
    # 定义从每个条目提取的字段
    [parse.list.fields]
      # 必需字段：标题
      title = [
        { type = "selector", query = "span.title", extract = "text" }
      ]
      
      # 必需字段：详情页链接
      url = [
        { type = "selector", query = "a.link", extract = "attr:href" },
        # 如果是相对URL，转换为绝对URL
        { type = "string", operation = "prepend", prefix = "https://{domain}" }
      ]
      
      # 可选字段：封面图
      cover = [
        { type = "selector", query = "img", extract = "attr:src", index = 0 }
      ]
      
      # 可选字段：简介
      description = [
        { type = "selector", query = "span.summary", extract = "text" }
      ]
      
      # 可选字段：年份（从标题或其他元素提取）
      year = [
        { type = "selector", query = "span.info", extract = "text" },
        # 使用正则表达式提取年份（假设格式为 "2023")
        { type = "regex", query = "(\\d{4})", group = 1 }
      ]
      
      # 可选字段：评分
      rating = [
        { type = "selector", query = "span.rating", extract = "text" },
        # 清理为纯数字
        { type = "regex", query = "([0-9.]+)", group = 1 }
      ]
      
      # 可选字段：视频类型
      video_type = [
        { type = "selector", query = "span.type", extract = "text" }
      ]
      
      # 可选字段：地区
      region = [
        { type = "selector", query = "span.info:nth-child(2)", extract = "text" }
      ]
      
      # 可选字段：语言
      language = [
        { type = "selector", query = "span.info:nth-child(3)", extract = "text" }
      ]
  
  # 详情页解析：从电影详情页提取完整信息
  [parse.detail]
    [parse.detail.fields]
      # 完整标题
      title = [
        { type = "selector", query = "h1.title", extract = "text" }
      ]
      
      # 详细描述
      description = [
        { type = "selector", query = "span.summary", extract = "text" }
      ]
      
      # 高清封面
      cover = [
        { type = "selector", query = "img.cover", extract = "attr:src" }
      ]
      
      # 标签（可能是多个）
      tags = [
        { type = "selector", query = "a.tag" }
      ]
      
      # 导演（影视特定字段）
      director = [
        { type = "selector", query = "span:contains('导演')", extract = "text" },
        # 清理文本
        { type = "regex", query = "导演：(.+)", group = 1 }
      ]
      
      # 演员（可能是列表）
      actors = [
        { type = "selector", query = "a.actor-name" }
      ]
      
      # 发布日期
      publish_date = [
        { type = "selector", query = "span:contains('上映日期')", extract = "text" },
        { type = "regex", query = "(\\d{4}-\\d{2}-\\d{2})", group = 1 }
      ]
      
      # 更新日期（可选）
      update_date = [
        { type = "selector", query = "span.update-time", extract = "text" }
      ]
      
      # 评分（详情页可能有更精确的评分）
      rating = [
        { type = "selector", query = "span.rating-value", extract = "text" }
      ]
      
      # 总集数（电视剧特定）
      episode_count = [
        { type = "selector", query = "span:contains('总集数')", extract = "text" },
        { type = "regex", query = "(\\d+)", group = 1 }
      ]
      
      # 当前更新到第几集
      current_episode = [
        { type = "selector", query = "span.current-episode", extract = "text" },
        { type = "regex", query = "第(\\d+)集", group = 1 }
      ]
      
      # 状态（完成/连载）
      status = [
        { type = "selector", query = "span.status", extract = "text" }
      ]
      
      # 视频播放链接列表（可能需要脚本解密）
      play_lines = [
        { type = "selector", query = "a.play-btn" }
      ]

# 脚本配置示例（可选）
# 当规则无法满足需求时，可以使用自定义脚本处理
[scripting]
engine = "javascript"
source_dir = "./scripts"

[scripting.files]
# 例如：某些字段可能加密或需要特殊处理
decrypt = "aes_decrypt.js"
# 用于处理动态加载的内容
extract = "dom_extractor.js"

# 脚本使用示例：
# 某个字段可以这样调用自定义脚本：
# field = [
#   { type = "selector", query = "div.encrypted", extract = "text" },
#   { type = "script", call = "decrypt.aesDecrypt", args = { key = "xxx" } }
# ]
