# æ ¸å¿ƒæ¦‚å¿µ

æœ¬æ–‡ä»‹ç»çˆ¬è™«è§„åˆ™çš„æ ¸å¿ƒæ¦‚å¿µå’Œè®¾è®¡ç†å¿µã€‚

## è§„åˆ™ç»“æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CrawlerRule                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [meta]        å…ƒæ•°æ®ï¼šåç§°ã€ä½œè€…ã€ç‰ˆæœ¬ã€åª’ä½“ç±»å‹        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [http]        HTTP é…ç½®ï¼ˆå¯é€‰ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [components]  å¯é‡ç”¨ç»„ä»¶å®šä¹‰ï¼ˆå¯é€‰ï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [search]      æœç´¢æµç¨‹ï¼ˆå¿…éœ€ï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [detail]      è¯¦æƒ…æµç¨‹ï¼ˆå¿…éœ€ï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [discovery]   å‘ç°æµç¨‹ï¼ˆå¯é€‰ï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [content]     å†…å®¹æµç¨‹ï¼ˆå¯é€‰ï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [login]       ç™»å½•æµç¨‹ï¼ˆå¯é€‰ï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [challenge]   äººæœºéªŒè¯å¤„ç†ï¼ˆå¯é€‰ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…ƒæ•°æ® (Meta)

å…ƒæ•°æ®æè¿°è§„åˆ™çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ˜¯è§„åˆ™çš„"èº«ä»½è¯"ã€‚

```toml
[meta]
name = "ç¤ºä¾‹è§†é¢‘ç«™"           # è§„åˆ™åç§°ï¼ˆå¿…éœ€ï¼‰
author = "your_name"          # ä½œè€…ï¼ˆå¿…éœ€ï¼‰
version = "1.0.0"             # è§„åˆ™ç‰ˆæœ¬ï¼ˆå¿…éœ€ï¼‰
spec_version = "1.0.0"        # è§„èŒƒç‰ˆæœ¬ï¼ˆå¿…éœ€ï¼‰
domain = "example.com"        # ç›®æ ‡åŸŸåï¼ˆå¿…éœ€ï¼‰
media_type = "video"          # åª’ä½“ç±»å‹ï¼ˆå¿…éœ€ï¼‰
description = "è§„åˆ™æè¿°"      # è¯¦ç»†æè¿°ï¼ˆå¯é€‰ï¼‰
icon_url = "https://..."      # å›¾æ ‡ URLï¼ˆå¯é€‰ï¼‰
encoding = "UTF-8"            # ç½‘ç«™ç¼–ç ï¼ˆå¯é€‰ï¼Œé»˜è®¤ UTF-8ï¼‰
```

### åª’ä½“ç±»å‹

| ç±»å‹ | è¯´æ˜ | å…¸å‹åœºæ™¯ |
|------|------|----------|
| `video` | è§†é¢‘ | ç”µå½±ã€ç”µè§†å‰§ã€åŠ¨æ¼«ã€ç»¼è‰º |
| `audio` | éŸ³é¢‘ | éŸ³ä¹ã€æ’­å®¢ã€æœ‰å£°ä¹¦ |
| `book` | ä¹¦ç± | å°è¯´ã€ç”µå­ä¹¦ |
| `manga` | æ¼«ç”» | æ¼«ç”»ã€æ¡æ¼« |

## å¯é‡ç”¨ç»„ä»¶ (Component)

ç»„ä»¶ç”¨äºå°è£…å¯å¤ç”¨çš„å­—æ®µæå–é€»è¾‘ï¼Œé¿å…é‡å¤ä»£ç ã€‚

### åŸºæœ¬ç»“æ„

```toml
[components.parse_video_url]
description = "è§£æåŠ å¯†çš„è§†é¢‘åœ°å€"
inputs = { encrypted_url = "" }

[components.parse_video_url.extractor]
steps = [
    { var = "encrypted_url" },
    { script = "decrypt.parse_m3u8" }
]
```

### ç»„ä»¶å±æ€§

| å±æ€§ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|
| `extractor` | âœ… | ç»„ä»¶çš„æå–é€»è¾‘ï¼ˆFieldExtractorï¼‰ |
| `inputs` | âŒ | è¾“å…¥å‚æ•°å®šä¹‰ï¼ˆkey: å‚æ•°å, value: é»˜è®¤å€¼ï¼‰ |
| `description` | âŒ | ç»„ä»¶åŠŸèƒ½æè¿° |

### ä½¿ç”¨ç»„ä»¶

åœ¨å­—æ®µæå–ä¸­é€šè¿‡ `component` æ­¥éª¤å¼•ç”¨ï¼š

```toml
# å®šä¹‰ç»„ä»¶
[components.clean_title]
description = "æ¸…ç†æ ‡é¢˜"
[components.clean_title.extractor]
steps = [{ filter = "trim | strip_html | collapse_whitespace" }]

# ä½¿ç”¨ç»„ä»¶
[search.fields]
title.steps = [
    { css = ".title" },
    { component = "clean_title" }
]

[detail.fields]
title.steps = [
    { css = "h1" },
    { component = "clean_title" }
]
```

### å¸¦å‚æ•°çš„ç»„ä»¶

```toml
# å®šä¹‰å¸¦å‚æ•°çš„ç»„ä»¶
[components.build_url]
description = "æ„å»ºå®Œæ•´ URL"
inputs = { path = "", base = "https://example.com" }

[components.build_url.extractor]
steps = [
    { var = "path" },
    { filter = "template('{{ base }}{{ value }}')" }
]

# ä½¿ç”¨æ—¶ä¼ å‚
[search.fields]
url.steps = [
    { css = "a" },
    { attr = "href" },
    { component = { name = "build_url", inputs = { base = "https://cdn.example.com" } } }
]
```

## æµç¨‹ (Flow)

æµç¨‹å®šä¹‰äº†å¦‚ä½•å¤„ç†ç‰¹å®šç±»å‹çš„é¡µé¢ã€‚æ¯ä¸ªæµç¨‹åŒ…å«ï¼š

1. **URL æ¨¡æ¿** - é¡µé¢åœ°å€
2. **å­—æ®µè§„åˆ™** - å¦‚ä½•æå–æ•°æ®
3. **é…ç½®é€‰é¡¹** - åˆ†é¡µã€ç­›é€‰ç­‰ï¼ˆéƒ¨åˆ†æµç¨‹ï¼‰

### æœç´¢æµç¨‹ (SearchFlow)

å®ç°å…³é”®è¯æœç´¢åŠŸèƒ½ã€‚

```toml
[search]
url = "https://example.com/search?q={{ keyword }}&page={{ page }}"

[search.pagination]
pagination_type = "page_number"
start_page = 1

[search.fields]
title.steps = [{ css = ".title" }]
url.steps = [{ css = "a" }, { attr = "href" }]
```

### è¯¦æƒ…æµç¨‹ (DetailFlow)

è·å–å†…å®¹çš„è¯¦ç»†ä¿¡æ¯ã€‚

```toml
[detail]
url = "{{ detail_url }}"

[detail.fields]
media_type = "video"
title.steps = [{ css = "h1" }]
cover.steps = [{ css = ".poster img" }, { attr = "src" }]
intro.steps = [{ css = ".description" }]
```

### å‘ç°æµç¨‹ (DiscoveryFlow)

æ”¯æŒåˆ†ç±»æµè§ˆå’Œç­›é€‰ã€‚

```toml
[discovery]
url = "https://example.com/list/{{ category }}/{{ area }}/{{ year }}/page/{{ page }}"

[discovery.categories]
type = "static"
items = [
    { key = "movie", label = "ç”µå½±" },
    { key = "tv", label = "ç”µè§†å‰§" }
]

[discovery.filters]
type = "static"
groups = [
    { name = "åœ°åŒº", key = "area", options = [
        { name = "å…¨éƒ¨", value = "all" },
        { name = "ä¸­å›½", value = "cn" },
        { name = "ç¾å›½", value = "us" }
    ]}
]

[discovery.fields]
title.steps = [{ css = ".title" }]
url.steps = [{ css = "a" }, { attr = "href" }]
```

### å†…å®¹æµç¨‹ (ContentFlow)

è§£æå®é™…çš„æ’­æ”¾/é˜…è¯»èµ„æºã€‚

```toml
[content]
url = "{{ play_url }}"

[content.fields]
media_type = "video"
play_url.steps = [
    { css = "#player" },
    { attr = "data-src" }
]
```

### ç™»å½•æµç¨‹ (LoginFlow)

å¤„ç†éœ€è¦è®¤è¯çš„ç½‘ç«™ï¼Œæ”¯æŒä¸‰ç§æ–¹å¼ï¼š

```toml
# æ–¹å¼1ï¼šè„šæœ¬äº¤äº’ç™»å½•
[login]
type = "script"
[[login.ui]]
type = "text"
key = "username"
label = "ç”¨æˆ·å"
[[login.ui]]
type = "password"
key = "password"
label = "å¯†ç "
[login.login_script]
code = '''
const res = await http.post("/api/login", {
    username: inputs.username,
    password: inputs.password
});
return { success: res.code === 0 };
'''

# æ–¹å¼2ï¼šWebView ç™»å½•
[login]
type = "webview"
start_url = "https://example.com/login"
check_script = "return document.querySelector('.user-info') !== null;"
timeout_seconds = 300

# æ–¹å¼3ï¼šå‡­è¯ç™»å½•
[login]
type = "credential"
tip = "è¯·è¾“å…¥ Cookie"
[[login.storage]]
type = "cookie"
```

### äººæœºéªŒè¯æµç¨‹ (ChallengeConfig)

å¤„ç†åçˆ¬éªŒè¯æœºåˆ¶ï¼Œå¦‚ Cloudflareã€reCAPTCHA ç­‰ã€‚

```toml
[challenge]
enabled = true
max_attempts = 3
cache_duration = 3600  # å‡­è¯ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰

# æ£€æµ‹å™¨ï¼šåˆ¤æ–­æ˜¯å¦è§¦å‘éªŒè¯
[[challenge.detectors]]
type = "cloudflare"

# å¤„ç†å™¨ï¼šå¦‚ä½•å®ŒæˆéªŒè¯
[challenge.handler]
type = "webview"
timeout_seconds = 120
success_check = "return !document.body.innerHTML.includes('Just a moment');"
```

æ”¯æŒçš„æ£€æµ‹å™¨ç±»å‹ï¼š

- `cloudflare` - Cloudflare éªŒè¯
- `recaptcha` - Google reCAPTCHA
- `hcaptcha` - hCaptcha
- `custom` - è‡ªå®šä¹‰æ£€æµ‹è§„åˆ™

æ”¯æŒçš„å¤„ç†å™¨ç±»å‹ï¼š

- `webview` - æ‰“å¼€æµè§ˆå™¨æ‰‹åŠ¨éªŒè¯
- `retry` - è‡ªåŠ¨é‡è¯•ï¼ˆé€‚ç”¨äº JS Challengeï¼‰
- `cookie` - Cookie æ³¨å…¥
- `external` - ç¬¬ä¸‰æ–¹æ‰“ç å¹³å°
- `script` - è‡ªå®šä¹‰è„šæœ¬å¤„ç†

## å­—æ®µè§„åˆ™ (FieldRule)

å­—æ®µè§„åˆ™å®šä¹‰å¦‚ä½•æå–å•ä¸ªæ•°æ®å­—æ®µã€‚

### åŸºæœ¬ç»“æ„

```toml
[search.fields]
# ç®€å•æå–
title.steps = [{ css = ".title" }]

# å¤šæ­¥éª¤æå–
cover.steps = [
    { css = "img.poster" },
    { attr = "src" },
    { filter = "absolute_url" }
]

# å¸¦å›é€€çš„æå–
author.steps = [{ css = ".author" }]
author.fallback = [
    [{ css = ".writer" }],
    [{ css = ".creator" }]
]
author.default = "ä½šå"
```

### å­—æ®µå±æ€§

| å±æ€§ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `steps` | æ•°ç»„ | æå–æ­¥éª¤åˆ—è¡¨ï¼ˆå¿…éœ€ï¼‰ |
| `fallback` | æ•°ç»„ | å›é€€æ­¥éª¤é“¾ï¼ˆå¯é€‰ï¼‰ |
| `default` | ä»»æ„ | é»˜è®¤å€¼ï¼ˆå¯é€‰ï¼‰ |
| `nullable` | å¸ƒå°” | æ˜¯å¦å…è®¸ç©ºå€¼ï¼ˆé»˜è®¤ falseï¼‰ |

## æå–æ­¥éª¤ (ExtractStep)

æ­¥éª¤æ˜¯æ•°æ®æå–çš„åŸå­æ“ä½œï¼Œåˆ†ä¸ºä¸‰ç±»ï¼š

### é€‰æ‹©æ­¥éª¤

ä»æ–‡æ¡£ä¸­é€‰æ‹©å†…å®¹ã€‚

| æ­¥éª¤ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|----------|------|
| `css` | HTML æ–‡æ¡£ | `{ css = ".title" }` |
| `xpath` | HTML/XML | `{ xpath = "//h1" }` |
| `json` | JSON æ•°æ® | `{ json = "$.data.list" }` |
| `regex` | æ–‡æœ¬åŒ¹é… | `{ regex = "id=(\\d+)" }` |

### è½¬æ¢æ­¥éª¤

å¯¹æ•°æ®è¿›è¡Œè½¬æ¢å¤„ç†ã€‚

| æ­¥éª¤ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| `attr` | è·å–å±æ€§ | `{ attr = "href" }` |
| `filter` | è¿‡æ»¤è½¬æ¢ | `{ filter = "trim" }` |
| `index` | ç´¢å¼•/åˆ‡ç‰‡ | `{ index = 0 }` æˆ– `{ index = "1:5" }` |

### ç‰¹æ®Šæ­¥éª¤

| æ­¥éª¤ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| `const` | å¸¸é‡å€¼ | `{ const = "é»˜è®¤å€¼" }` |
| `var` | ä¸Šä¸‹æ–‡å˜é‡ | `{ var = "base_url" }` |
| `script` | è„šæœ¬è°ƒç”¨ | `{ script = "utils.decrypt" }` |

## æ¨¡æ¿ç³»ç»Ÿ

URL å’Œå­—ç¬¦ä¸²æ”¯æŒ Tera æ¨¡æ¿è¯­æ³•ï¼š

### å˜é‡æ’å€¼

```
{{ variable }}
{{ user.name }}
{{ items[0].title }}
```

### è¿‡æ»¤å™¨

```
{{ title | trim }}
{{ name | upper }}
{{ url | urlencode }}
```

### æ¡ä»¶å’Œå¾ªç¯ï¼ˆé«˜çº§ï¼‰

```
{% if condition %}...{% endif %}
{% for item in items %}...{% endfor %}
```

## æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœç´¢é¡µ   â”‚â”€â”€â”€â–¶â”‚  åˆ—è¡¨æ•°æ®  â”‚â”€â”€â”€â–¶â”‚  è¯¦æƒ…é¡µ   â”‚â”€â”€â”€â–¶â”‚  è¯¦æƒ…æ•°æ®  â”‚
â”‚ (search) â”‚    â”‚(ItemFields)â”‚   â”‚ (detail) â”‚    â”‚(DetailFields)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚  å†…å®¹é¡µ   â”‚â”€â”€â”€â–¶â”‚  æ’­æ”¾æ•°æ®  â”‚
                                â”‚(content) â”‚    â”‚(ContentFields)â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸‹ä¸€æ­¥

- ğŸ”§ [å­—æ®µæå–](./extraction.md) - æŒæ¡æ•°æ®æå–æŠ€å·§
- ğŸ“‹ [æœç´¢æµç¨‹](../flows/search.md) - å®Œæ•´çš„æœç´¢é…ç½®
- ğŸ›¡ï¸ [äººæœºéªŒè¯](../flows/challenge.md) - å¤„ç†åçˆ¬éªŒè¯
- ğŸ“– [æå–æ­¥éª¤å‚è€ƒ](../reference/steps.md) - æ‰€æœ‰æ­¥éª¤è¯¦è§£
