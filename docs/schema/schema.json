{
  "$comment": "Schema version: 1.0.0",
  "$defs": {
    "CacheScope": {
      "description": "缓存作用域 (CacheScope)\n用于指定缓存数据的生命周期范围。",
      "oneOf": [
        {
          "const": "flow",
          "description": "流程级缓存，在单个流程执行期间有效（默认）。",
          "type": "string"
        },
        {
          "const": "rule",
          "description": "规则级缓存，在整个规则生命周期内有效，规则删除时缓存也删除。",
          "type": "string"
        }
      ]
    },
    "Component": {
      "additionalProperties": false,
      "description": "可重用组件 (Component)\n一个可被其他管道调用的、封装了特定逻辑的子管道。",
      "properties": {
        "description": {
          "description": "组件的功能描述。",
          "type": [
            "string",
            "null"
          ]
        },
        "inputs": {
          "additionalProperties": true,
          "description": "定义组件接收的输入参数 (key: 参数名, value: 默认值)。",
          "type": "object"
        },
        "pipeline": {
          "description": "组件的核心处理管道。",
          "items": {
            "$ref": "#/$defs/Step"
          },
          "type": "array"
        }
      },
      "required": [
        "inputs",
        "pipeline"
      ],
      "type": "object"
    },
    "CredentialField": {
      "additionalProperties": false,
      "description": "凭证字段定义",
      "properties": {
        "field_type": {
          "$ref": "#/$defs/CredentialFieldType",
          "default": "text",
          "description": "字段类型"
        },
        "key": {
          "$ref": "#/$defs/Identifier",
          "description": "字段标识符"
        },
        "label": {
          "description": "字段显示名称",
          "type": "string"
        },
        "placeholder": {
          "description": "占位符文本",
          "type": [
            "string",
            "null"
          ]
        },
        "required": {
          "default": true,
          "description": "是否必填",
          "type": "boolean"
        }
      },
      "required": [
        "key",
        "label"
      ],
      "type": "object"
    },
    "CredentialFieldType": {
      "description": "凭证字段类型",
      "oneOf": [
        {
          "const": "text",
          "description": "普通文本",
          "type": "string"
        },
        {
          "const": "password",
          "description": "密码（隐藏显示）",
          "type": "string"
        },
        {
          "const": "email",
          "description": "邮箱",
          "type": "string"
        },
        {
          "const": "textarea",
          "description": "多行文本（如Cookie）",
          "type": "string"
        }
      ]
    },
    "DetailFlow": {
      "additionalProperties": false,
      "description": "详情页流程 (DetailFlow)\n处理单个内容项的详细信息",
      "properties": {
        "description": {
          "description": "流程的功能描述",
          "type": [
            "string",
            "null"
          ]
        },
        "pipeline": {
          "description": "详情页处理管道",
          "items": {
            "$ref": "#/$defs/Step"
          },
          "type": "array"
        }
      },
      "required": [
        "pipeline"
      ],
      "type": "object"
    },
    "ExtractType": {
      "anyOf": [
        {
          "const": "text",
          "description": "提取文本内容",
          "type": "string"
        },
        {
          "const": "html",
          "description": "提取内部HTML",
          "type": "string"
        },
        {
          "const": "outer_html",
          "description": "提取完整HTML",
          "type": "string"
        },
        {
          "const": "attr:href",
          "description": "提取 `href` 属性",
          "type": "string"
        },
        {
          "const": "attr:src",
          "description": "提取 `src` 属性",
          "type": "string"
        },
        {
          "const": "attr:data-src",
          "description": "提取 `data-src` 属性",
          "type": "string"
        },
        {
          "const": "attr:alt",
          "description": "提取 `alt` 属性",
          "type": "string"
        },
        {
          "const": "attr:title",
          "description": "提取 `title` 属性",
          "type": "string"
        },
        {
          "const": "attr:class",
          "description": "提取 `class` 属性",
          "type": "string"
        },
        {
          "const": "attr:id",
          "description": "提取 `id` 属性",
          "type": "string"
        },
        {
          "const": "attr:value",
          "description": "提取 `value` 属性",
          "type": "string"
        },
        {
          "description": "提取自定义属性，格式为 `attr:your-attribute-name`",
          "type": "string"
        }
      ],
      "description": "选择器提取方式"
    },
    "FieldMapping": {
      "additionalProperties": false,
      "description": "字段映射规则 (FieldMapping)\n定义源字段到目标字段的映射关系。",
      "properties": {
        "from": {
          "description": "源字段路径，支持点号访问嵌套字段，如 \"data.title\" 或简单字段名 \"title\"",
          "type": "string"
        },
        "to": {
          "description": "目标字段名，必须是目标模型中的有效字段名\n如 ItemSummary: id, title, url, media_type, cover, summary, tags, meta\n如 ItemDetail: id, title, url, media_type, cover, description, metadata, tags, content",
          "type": "string"
        },
        "transform": {
          "description": "可选的转换函数（预留），如 \"to_lowercase\", \"trim\", \"parse_int\" 等",
          "type": [
            "string",
            "null"
          ]
        }
      },
      "required": [
        "from",
        "to"
      ],
      "type": "object"
    },
    "FilterGroup": {
      "additionalProperties": false,
      "description": "代表UI上一组相关的筛选选项，如\"地区\"、\"年份\"。",
      "properties": {
        "key": {
          "$ref": "#/$defs/Identifier",
          "description": "此筛选器组在URL模板中对应的键 (`key`)。\n例如，如果 `key` 是 `\"cate_id\"`，则UI会将用户选择的值替换到URL的 `{{cate_id}}` 位置。"
        },
        "multiselect": {
          "default": false,
          "description": "是否允许多选。",
          "type": "boolean"
        },
        "name": {
          "description": "筛选器组的显示名称，如 \"按类型\"。",
          "type": "string"
        },
        "options": {
          "description": "此筛选器组下所有可用的选项。",
          "items": {
            "$ref": "#/$defs/FilterOption"
          },
          "type": "array"
        }
      },
      "required": [
        "name",
        "key",
        "options"
      ],
      "title": "筛选器组 (FilterGroup)",
      "type": "object"
    },
    "FilterOption": {
      "additionalProperties": false,
      "description": "代表一个具体的筛选选项，如\"电影\"或\"2023年\"。",
      "properties": {
        "name": {
          "description": "选项的显示名称，如 \"美国\"。",
          "type": "string"
        },
        "value": {
          "description": "选项的值，将用于替换URL模板中对应的 `key`。\n例如，如果 `key` 是 `\"area\"`，此 `value` 可能是 `\"USA\"`。",
          "type": "string"
        }
      },
      "required": [
        "name",
        "value"
      ],
      "title": "筛选器选项 (FilterOption)",
      "type": "object"
    },
    "HttpConfig": {
      "additionalProperties": false,
      "description": "全局HTTP配置 (HttpConfig)\n定义所有网络请求的默认行为。",
      "properties": {
        "connect_timeout": {
          "description": "连接超时时间（秒）。",
          "format": "uint32",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "follow_redirects": {
          "description": "是否允许重定向。",
          "type": [
            "boolean",
            "null"
          ]
        },
        "headers": {
          "additionalProperties": {
            "type": "string"
          },
          "description": "全局请求头。",
          "type": [
            "object",
            "null"
          ]
        },
        "max_concurrent": {
          "description": "最大并发请求数。",
          "format": "uint32",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "max_redirects": {
          "description": "最大重定向次数。",
          "format": "uint32",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "proxy": {
          "description": "全局代理地址。",
          "type": [
            "string",
            "null"
          ]
        },
        "request_delay": {
          "description": "请求间隔时间（毫秒），用于限流。",
          "format": "uint32",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "retry_count": {
          "description": "重试次数。",
          "format": "uint32",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "retry_delay": {
          "description": "重试间隔（毫秒）。",
          "format": "uint32",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "timeout": {
          "description": "全局请求超时时间（秒）。",
          "format": "uint32",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "user_agent": {
          "description": "全局 User-Agent。",
          "type": [
            "string",
            "null"
          ]
        },
        "verify_ssl": {
          "description": "是否验证SSL证书。",
          "type": [
            "boolean",
            "null"
          ]
        }
      },
      "type": "object"
    },
    "HttpMethod": {
      "description": "HTTP 请求方法 (HttpMethod)\n用于指定网络请求的 HTTP 方法。",
      "oneOf": [
        {
          "const": "GET",
          "description": "GET 请求，通常用于获取数据。",
          "type": "string"
        },
        {
          "const": "POST",
          "description": "POST 请求，通常用于提交数据。",
          "type": "string"
        },
        {
          "const": "PUT",
          "description": "PUT 请求，通常用于更新数据。",
          "type": "string"
        },
        {
          "const": "DELETE",
          "description": "DELETE 请求，通常用于删除数据。",
          "type": "string"
        },
        {
          "const": "HEAD",
          "description": "HEAD 请求，类似于 GET，但只获取响应头。",
          "type": "string"
        },
        {
          "const": "OPTIONS",
          "description": "OPTIONS 请求，获取服务器支持的HTTP方法。",
          "type": "string"
        },
        {
          "const": "PATCH",
          "description": "PATCH 请求，用于部分更新数据。",
          "type": "string"
        }
      ]
    },
    "Identifier": {
      "description": "标识符 (Identifier)\n用于校验变量名、组件名、流程名等。\n必须由字母、数字和下划线组成，且不能以数字开头。",
      "type": "string"
    },
    "ListFlow": {
      "additionalProperties": false,
      "description": "列表页流程 (ListFlow)\n用于发现和浏览内容列表",
      "properties": {
        "description": {
          "description": "流程的功能描述",
          "type": [
            "string",
            "null"
          ]
        },
        "filters": {
          "description": "筛选器配置",
          "items": {
            "$ref": "#/$defs/FilterGroup"
          },
          "type": [
            "array",
            "null"
          ]
        },
        "pagination": {
          "anyOf": [
            {
              "$ref": "#/$defs/PaginationConfig"
            },
            {
              "type": "null"
            }
          ],
          "description": "分页配置"
        },
        "pipeline": {
          "description": "列表页处理管道",
          "items": {
            "$ref": "#/$defs/Step"
          },
          "type": "array"
        }
      },
      "required": [
        "pipeline"
      ],
      "type": "object"
    },
    "LoginFlow": {
      "additionalProperties": false,
      "description": "登录流程 (LoginFlow)\n处理网站的身份验证，支持多种认证方式",
      "properties": {
        "check_login": {
          "description": "登录验证：检查是否已登录的管道",
          "items": {
            "$ref": "#/$defs/Step"
          },
          "type": [
            "array",
            "null"
          ]
        },
        "credentials": {
          "description": "登录所需的凭证字段定义",
          "items": {
            "$ref": "#/$defs/CredentialField"
          },
          "type": [
            "array",
            "null"
          ]
        },
        "description": {
          "description": "流程的功能描述",
          "type": [
            "string",
            "null"
          ]
        },
        "login_type": {
          "$ref": "#/$defs/LoginType",
          "default": "password",
          "description": "登录类型"
        },
        "pipeline": {
          "description": "登录动作管道",
          "items": {
            "$ref": "#/$defs/Step"
          },
          "type": "array"
        }
      },
      "required": [
        "pipeline"
      ],
      "type": "object"
    },
    "LoginType": {
      "description": "登录类型",
      "oneOf": [
        {
          "const": "password",
          "description": "用户名密码登录",
          "type": "string"
        },
        {
          "const": "cookie",
          "description": "Cookie登录",
          "type": "string"
        },
        {
          "const": "token",
          "description": "Token登录",
          "type": "string"
        },
        {
          "const": "o_auth",
          "description": "OAuth登录",
          "type": "string"
        },
        {
          "const": "captcha",
          "description": "验证码登录",
          "type": "string"
        }
      ]
    },
    "MediaType": {
      "description": "用于指定规则适用的媒体内容类型。",
      "oneOf": [
        {
          "const": "video",
          "description": "视频类型，如电影、电视剧等。",
          "type": "string"
        },
        {
          "const": "audio",
          "description": "音频类型，如音乐、播客等。",
          "type": "string"
        },
        {
          "const": "book",
          "description": "书籍类型，如电子书、小说等。",
          "type": "string"
        },
        {
          "const": "manga",
          "description": "漫画类型，如漫画、图画书等。",
          "type": "string"
        }
      ]
    },
    "Meta": {
      "additionalProperties": false,
      "description": "元数据 (Meta)\n描述规则的基本信息。",
      "properties": {
        "author": {
          "description": "规则作者。",
          "type": "string"
        },
        "description": {
          "description": "规则的详细描述。",
          "type": [
            "string",
            "null"
          ]
        },
        "domain": {
          "description": "目标网站的主域名。",
          "type": "string"
        },
        "encoding": {
          "description": "目标网站的编码，默认为 \"UTF-8\"。",
          "type": [
            "string",
            "null"
          ]
        },
        "icon_url": {
          "description": "数据源的图标URL，用于UI展示。",
          "type": [
            "string",
            "null"
          ]
        },
        "media_type": {
          "$ref": "#/$defs/MediaType",
          "description": "规则主要适用的媒体类型。"
        },
        "name": {
          "description": "规则名称，如“示例影视站”。",
          "type": "string"
        },
        "spec_version": {
          "description": "本规则遵循的规范版本号。",
          "type": "string"
        },
        "version": {
          "description": "规则版本号，建议遵循 SemVer (如 \"1.0.2\")。",
          "type": "string"
        }
      },
      "required": [
        "name",
        "author",
        "version",
        "spec_version",
        "domain",
        "media_type"
      ],
      "type": "object"
    },
    "PaginationConfig": {
      "additionalProperties": false,
      "description": "分页配置",
      "properties": {
        "max_pages": {
          "description": "最大页数限制",
          "format": "uint32",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "page_param": {
          "$ref": "#/$defs/Identifier",
          "default": "page",
          "description": "页码参数名"
        },
        "page_size": {
          "description": "每页数量（如果适用）",
          "format": "uint32",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "pagination_type": {
          "$ref": "#/$defs/PaginationType",
          "default": "page_number",
          "description": "分页类型"
        },
        "start_page": {
          "default": 1,
          "description": "起始页码",
          "format": "uint32",
          "minimum": 0,
          "type": "integer"
        }
      },
      "type": "object"
    },
    "PaginationType": {
      "description": "分页类型",
      "oneOf": [
        {
          "const": "page_number",
          "description": "页码分页",
          "type": "string"
        },
        {
          "const": "offset",
          "description": "偏移量分页",
          "type": "string"
        },
        {
          "const": "cursor",
          "description": "游标分页",
          "type": "string"
        },
        {
          "const": "load_more",
          "description": "加载更多（无限滚动）",
          "type": "string"
        }
      ]
    },
    "RuntimeLimits": {
      "additionalProperties": false,
      "description": "运行时限制配置\n用于限制规则执行时的资源使用",
      "properties": {
        "execution_timeout_ms": {
          "default": 30000,
          "description": "整体执行超时时间（毫秒）",
          "format": "uint64",
          "minimum": 0,
          "type": "integer"
        },
        "max_concurrent_requests": {
          "description": "最大并发请求数",
          "format": "uint",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "max_http_requests": {
          "description": "最大HTTP请求数",
          "format": "uint",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "max_loop_iterations": {
          "default": 10000,
          "description": "单次循环的最大迭代次数",
          "format": "uint",
          "minimum": 0,
          "type": "integer"
        },
        "max_pipeline_length": {
          "default": 100,
          "description": "单个管道的最大步骤数",
          "format": "uint",
          "minimum": 0,
          "type": "integer"
        },
        "max_recursion_depth": {
          "default": 10,
          "description": "组件调用的最大递归深度",
          "format": "uint",
          "minimum": 0,
          "type": "integer"
        },
        "max_response_size": {
          "description": "最大响应体大小（字节）",
          "format": "uint",
          "minimum": 0,
          "type": [
            "integer",
            "null"
          ]
        },
        "max_string_length": {
          "default": 10485760,
          "description": "单个字符串的最大长度（字节）",
          "format": "uint",
          "minimum": 0,
          "type": "integer"
        },
        "max_variables": {
          "default": 1000,
          "description": "变量上下文中的最大变量数量",
          "format": "uint",
          "minimum": 0,
          "type": "integer"
        }
      },
      "type": "object"
    },
    "ScriptEngine": {
      "description": "脚本引擎类型 (ScriptEngine)\n用于指定脚本执行环境的类型。",
      "oneOf": [
        {
          "const": "rhai",
          "description": "Rhai 脚本引擎（默认）。",
          "type": "string"
        },
        {
          "const": "javascript",
          "description": "JavaScript 脚本引擎。",
          "type": "string"
        },
        {
          "const": "python",
          "description": "Python 脚本引擎。",
          "type": "string"
        },
        {
          "const": "lua",
          "description": "Lua 脚本引擎。",
          "type": "string"
        }
      ]
    },
    "ScriptModule": {
      "description": "脚本模块 (ScriptModule)\n定义一个脚本文件的来源。",
      "oneOf": [
        {
          "description": "直接内联在规则中的代码。",
          "properties": {
            "code": {
              "type": "string"
            }
          },
          "required": [
            "code"
          ],
          "type": "object"
        },
        {
          "description": "相对于规则文件的脚本路径。",
          "properties": {
            "file": {
              "type": "string"
            }
          },
          "required": [
            "file"
          ],
          "type": "object"
        },
        {
          "description": "远程URL加载的脚本。",
          "properties": {
            "url": {
              "type": "string"
            }
          },
          "required": [
            "url"
          ],
          "type": "object"
        }
      ],
      "properties": {
        "engine": {
          "anyOf": [
            {
              "$ref": "#/$defs/ScriptEngine"
            },
            {
              "type": "null"
            }
          ],
          "description": "脚本引擎，如果指定，则覆盖全局配置。"
        }
      },
      "type": "object"
    },
    "ScriptingConfig": {
      "additionalProperties": false,
      "description": "脚本配置 (ScriptingConfig)\n配置用于执行自定义逻辑的脚本环境。",
      "properties": {
        "engine": {
          "$ref": "#/$defs/ScriptEngine",
          "description": "默认脚本引擎。"
        },
        "modules": {
          "additionalProperties": {
            "$ref": "#/$defs/ScriptModule"
          },
          "description": "定义脚本模块，key 为模块名，用于在 `script` 步骤中调用。",
          "type": "object"
        }
      },
      "required": [
        "engine",
        "modules"
      ],
      "type": "object"
    },
    "SearchFlow": {
      "additionalProperties": false,
      "description": "搜索流程 (SearchFlow)\n处理搜索功能",
      "properties": {
        "description": {
          "description": "流程的功能描述",
          "type": [
            "string",
            "null"
          ]
        },
        "filters": {
          "description": "搜索筛选器",
          "items": {
            "$ref": "#/$defs/FilterGroup"
          },
          "type": [
            "array",
            "null"
          ]
        },
        "pagination": {
          "anyOf": [
            {
              "$ref": "#/$defs/PaginationConfig"
            },
            {
              "type": "null"
            }
          ],
          "description": "分页配置"
        },
        "pipeline": {
          "description": "搜索处理管道",
          "items": {
            "$ref": "#/$defs/Step"
          },
          "type": "array"
        }
      },
      "required": [
        "pipeline"
      ],
      "type": "object"
    },
    "Step": {
      "description": "步骤 (Step)\n管道中的一个原子操作单元。",
      "oneOf": [
        {
          "additionalProperties": false,
          "description": "**HTTP请求**: 发起网络请求。",
          "properties": {
            "body": {
              "anyOf": [
                {
                  "$ref": "#/$defs/Template"
                },
                {
                  "type": "null"
                }
              ],
              "description": "POST请求体。\n模板字符串，详见顶部规范说明。"
            },
            "headers": {
              "additionalProperties": {
                "$ref": "#/$defs/Template"
              },
              "description": "本次请求的自定义头。\n请求头模板字符串，详见顶部规范说明。",
              "type": [
                "object",
                "null"
              ]
            },
            "method": {
              "anyOf": [
                {
                  "$ref": "#/$defs/HttpMethod"
                },
                {
                  "type": "null"
                }
              ],
              "description": "HTTP方法。"
            },
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "将包含响应体、状态码、头的响应对象存入此变量。"
            },
            "type": {
              "const": "http_request",
              "type": "string"
            },
            "url": {
              "$ref": "#/$defs/Template",
              "description": "要请求的URL。\n模板字符串，详见顶部规范说明。"
            }
          },
          "required": [
            "type",
            "url",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**CSS选择器**: 从HTML中提取单个元素。",
          "properties": {
            "extract": {
              "$ref": "#/$defs/ExtractType",
              "description": "提取方式。"
            },
            "input": {
              "$ref": "#/$defs/Template",
              "description": "输入的HTML字符串。\n模板字符串，详见顶部规范说明。"
            },
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "将提取的结果存入此变量。"
            },
            "query": {
              "$ref": "#/$defs/Template",
              "description": "CSS选择器表达式。\n模板字符串，详见顶部规范说明。"
            },
            "type": {
              "const": "selector",
              "type": "string"
            }
          },
          "required": [
            "type",
            "input",
            "query",
            "extract",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**CSS选择器(全部)**: 从HTML中提取所有匹配的元素数组。",
          "properties": {
            "extract": {
              "$ref": "#/$defs/ExtractType",
              "description": "提取方式。"
            },
            "input": {
              "$ref": "#/$defs/Template",
              "description": "输入的HTML字符串。\n模板字符串，详见顶部规范说明。"
            },
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "将提取的字符串数组存入此变量。"
            },
            "query": {
              "$ref": "#/$defs/Template",
              "description": "CSS选择器表达式。\n模板字符串，详见顶部规范说明。"
            },
            "type": {
              "const": "selector_all",
              "type": "string"
            }
          },
          "required": [
            "type",
            "input",
            "query",
            "extract",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**JSONPath**: 从JSON数据中提取信息。",
          "properties": {
            "input": {
              "$ref": "#/$defs/Template",
              "description": "输入的JSON字符串或对象。\n模板字符串，详见顶部规范说明。"
            },
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "将提取结果存入此变量。"
            },
            "query": {
              "$ref": "#/$defs/Template",
              "description": "JSONPath 查询表达式。\n模板字符串，详见顶部规范说明。"
            },
            "type": {
              "const": "json_path",
              "type": "string"
            }
          },
          "required": [
            "type",
            "input",
            "query",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**执行脚本**: 调用脚本模块中的函数。",
          "properties": {
            "call": {
              "description": "要调用的函数，格式为 `模块名.函数名`。",
              "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*\\.[a-zA-Z_][a-zA-Z0-9_]*$",
              "type": "string"
            },
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "将函数返回值存入此变量。"
            },
            "type": {
              "const": "script",
              "type": "string"
            },
            "with": {
              "anyOf": [
                {
                  "$ref": "#/$defs/Template"
                },
                {
                  "type": "null"
                }
              ],
              "description": "传递给函数的参数。这是一个动态值，允许在模板中构建复杂的JSON对象。\n模板字符串，详见顶部规范说明。"
            }
          },
          "required": [
            "type",
            "call",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**调用组件**: 执行一个在 `[components]` 中定义的组件。",
          "properties": {
            "component": {
              "$ref": "#/$defs/Identifier",
              "description": "要调用的组件名，必须在 `[components]` 中定义。"
            },
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "将组件的输出（一个包含所有输出变量的Map）存入此变量。"
            },
            "type": {
              "const": "call",
              "type": "string"
            },
            "with": {
              "additionalProperties": {
                "$ref": "#/$defs/Template"
              },
              "description": "传递给组件的输入参数。\n输入参数模板字符串，详见顶部规范说明。",
              "type": [
                "object",
                "null"
              ]
            }
          },
          "required": [
            "type",
            "component",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**字符串操作: 模板**: 使用变量格式化字符串。",
          "properties": {
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "输出结果变量名。"
            },
            "template": {
              "$ref": "#/$defs/Template",
              "description": "模板字符串。"
            },
            "type": {
              "const": "string_template",
              "type": "string"
            }
          },
          "required": [
            "type",
            "template",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**设置常量**: 创建一个值为常量的变量。",
          "properties": {
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "将此常量存入的变量名。"
            },
            "type": {
              "const": "constant",
              "type": "string"
            },
            "value": {
              "description": "常量值。"
            }
          },
          "required": [
            "type",
            "value",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**字段映射**: 将解析层字段映射到渲染层标准模型。",
          "properties": {
            "input": {
              "$ref": "#/$defs/Template",
              "description": "输入数据的变量名或模板字符串。\n模板字符串，详见顶部规范说明。"
            },
            "mappings": {
              "description": "字段映射规则列表。",
              "items": {
                "$ref": "#/$defs/FieldMapping"
              },
              "type": "array"
            },
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "将映射结果存入此变量。"
            },
            "target": {
              "description": "目标模型类型: \"item_summary\" 或 \"item_detail\"",
              "pattern": "^(item_summary|item_detail)$",
              "type": "string"
            },
            "type": {
              "const": "map_field",
              "type": "string"
            }
          },
          "required": [
            "type",
            "input",
            "target",
            "mappings",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**缓存获取**: 从缓存中获取值。",
          "properties": {
            "key": {
              "$ref": "#/$defs/Template",
              "description": "缓存键。\n模板字符串，详见顶部规范说明。"
            },
            "output": {
              "$ref": "#/$defs/Identifier",
              "description": "将获取的值存入此变量。"
            },
            "scope": {
              "anyOf": [
                {
                  "$ref": "#/$defs/CacheScope"
                },
                {
                  "type": "null"
                }
              ],
              "description": "缓存作用域。"
            },
            "type": {
              "const": "cache_get",
              "type": "string"
            }
          },
          "required": [
            "type",
            "key",
            "output"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**缓存设置**: 将值存入缓存。",
          "properties": {
            "key": {
              "$ref": "#/$defs/Template",
              "description": "缓存键。\n模板字符串，详见顶部规范说明。"
            },
            "scope": {
              "anyOf": [
                {
                  "$ref": "#/$defs/CacheScope"
                },
                {
                  "type": "null"
                }
              ],
              "description": "缓存作用域。"
            },
            "ttl": {
              "description": "过期时间（秒）。",
              "format": "uint32",
              "minimum": 0,
              "type": [
                "integer",
                "null"
              ]
            },
            "type": {
              "const": "cache_set",
              "type": "string"
            },
            "value": {
              "$ref": "#/$defs/Template",
              "description": "要缓存的值。\n模板字符串，详见顶部规范说明。"
            }
          },
          "required": [
            "type",
            "key",
            "value"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**循环: ForEach**: 遍历数组中的每一项并执行子管道。",
          "properties": {
            "as": {
              "$ref": "#/$defs/Identifier",
              "description": "在循环中，当前项的变量名。"
            },
            "input": {
              "$ref": "#/$defs/Template",
              "description": "要遍历的数组变量。\n模板字符串，详见顶部规范说明。"
            },
            "pipeline": {
              "description": "对每一项执行的子管道。",
              "items": {
                "$ref": "#/$defs/Step"
              },
              "type": "array"
            },
            "type": {
              "const": "loop_for_each",
              "type": "string"
            }
          },
          "required": [
            "type",
            "input",
            "as",
            "pipeline"
          ],
          "type": "object"
        },
        {
          "additionalProperties": false,
          "description": "**日志输出**: 打印调试信息。",
          "properties": {
            "message": {
              "$ref": "#/$defs/Template",
              "description": "要打印的消息。\n模板字符串，详见顶部规范说明。"
            },
            "type": {
              "const": "log",
              "type": "string"
            }
          },
          "required": [
            "type",
            "message"
          ],
          "type": "object"
        }
      ]
    },
    "Template": {
      "description": "模板字符串 (Template)\n\n支持 Tera 模板语法的字符串类型，用于在运行时进行变量插值。\n\n## 语法规范\n- 变量插值: `{{ variable }}`\n- 嵌套访问: `{{ user.name }}`, `{{ items[0] }}`\n- 过滤器: `{{ name | upper }}`\n- 条件: `{% if condition %}...{% endif %}`\n- 循环: `{% for item in items %}...{% endfor %}`\n\n## 示例\n```text\nhttps://example.com/search?q={{ keyword }}\nHello, {{ user.name }}!\n{{ items[0].title }}\n```",
      "pattern": "{{\\s*([a-zA-Z_][a-zA-Z0-9_]*(?:\\.[a-zA-Z_][a-zA-Z0-9_]*|\\[[0-9]+\\])*)\\s*}}",
      "type": "string"
    }
  },
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "additionalProperties": false,
  "description": "影视软件爬虫规则 (CrawlerRule)",
  "properties": {
    "components": {
      "additionalProperties": {
        "$ref": "#/$defs/Component"
      },
      "description": "定义可在此规则中复用的\"组件\"或\"函数\"。",
      "type": "object"
    },
    "detail": {
      "$ref": "#/$defs/DetailFlow",
      "description": "详情页流程（必需）"
    },
    "http": {
      "anyOf": [
        {
          "$ref": "#/$defs/HttpConfig"
        },
        {
          "type": "null"
        }
      ],
      "description": "全局的网络请求配置，可被流程局部配置覆盖。"
    },
    "limits": {
      "anyOf": [
        {
          "$ref": "#/$defs/RuntimeLimits"
        },
        {
          "type": "null"
        }
      ],
      "description": "运行时资源限制配置。"
    },
    "list": {
      "anyOf": [
        {
          "$ref": "#/$defs/ListFlow"
        },
        {
          "type": "null"
        }
      ],
      "description": "列表页流程（可选）"
    },
    "login": {
      "anyOf": [
        {
          "$ref": "#/$defs/LoginFlow"
        },
        {
          "type": "null"
        }
      ],
      "description": "登录流程（可选）"
    },
    "meta": {
      "$ref": "#/$defs/Meta",
      "description": "规则的元数据，用于在软件中识别和展示。"
    },
    "scripting": {
      "anyOf": [
        {
          "$ref": "#/$defs/ScriptingConfig"
        },
        {
          "type": "null"
        }
      ],
      "description": "脚本引擎的全局配置。"
    },
    "search": {
      "$ref": "#/$defs/SearchFlow",
      "description": "搜索流程（必需）"
    }
  },
  "required": [
    "meta",
    "components",
    "detail",
    "search"
  ],
  "title": "CrawlerRule",
  "type": "object"
}
